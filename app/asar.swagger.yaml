openapi: 3.0.0
info:
  title: Asar API
  version: 1.0.0
  description: API documentation for Asar Gold project

servers:
  - url: http://localhost:1000/api/v1
    description: Local Development
  - url: https://asarmulticenter.ir/app/api/v1
    description: Production

tags:
  - name: auth
    description: Authentication via OTP
  - name: pages
    description: Retrieving dynamic page layouts
  - name: categories
    description: Endpoints for retrieving post categories
  - name: articles
    description: Endpoints for retrieving articles (posts)
  - name: comments
    description: Endpoints for managing comments
  - name: bookmarks
    description: Endpoints for managing article bookmarks
  - name: likes
    description: Endpoints for managing article likes
  - name: File Upload
    description: Endpoints for file management
  - name: remote_config
    description: Remote Configuration

paths:
  /auth/send-otp:
    post:
      tags:
        - auth
      summary: Send OTP code to user
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - phone
              properties:
                phone:
                  type: string
                  example: "09038177456"
      responses:
        "200":
          description: OTP sent successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: integer
                    example: 200
                  message:
                    type: string
                    example: "code sent"
                  code:
                    type: string
                    example: "1234"
        "400":
          description: Too many requests or invalid input
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Code already sent"
  /auth/confirm-code:
    post:
      tags:
        - auth
      summary: Verify OTP code
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - phone
                - code
              properties:
                phone:
                  type: string
                  example: "09038177456"
                code:
                  type: string
                  example: "1234"
      responses:
        "200":
          description: Verified and authenticated
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "authorized"
                  token:
                    type: string
                    example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                  user:
                    type: object
                    properties:
                      id:
                        type: string
                      firstname:
                        type: string
                      lastname:
                        type: string
                      phone:
                        type: string
                      profile_pic:
                        type: string
                      role:
                        type: string
                      createdAt:
                        type: string
                        format: date-time
        "400":
          description: Invalid or expired code
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Invalid code or phone number"
  /file:
    post:
      tags:
        - File Upload
      summary: Upload a public file
      description: >
        Uploads a file (image, video, audio, pdf) to the public storage.
        Requires a valid Bearer token and the X-Public-Upload key.
      security:
        - bearerAuth: []
      parameters:
        - name: X-Public-Upload
          in: header
          required: true
          schema:
            type: string
          description: "A secret key required for public uploads."
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
                  description: "The file to upload."
      responses:
        "201":
          description: File uploaded successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "information updated"
                  result:
                    type: object
                    properties:
                      fileAddr:
                        type: string
                        example: "https://your-storage.com/uploads/file.png"
        "400":
          description: Bad Request (e.g., file not provided, invalid file type)
        "401":
          description: Unauthorized (Invalid or missing token)
        "403":
          description: Forbidden (Invalid X-Public-Upload key)
  /pages/{slug}:
    get:
      tags:
        - pages
      summary: Get resolved page by slug
      description: Returns the fully resolved JSON layout for a page (e.g., "home") based on its slug and language.
      parameters:
        - name: slug
          in: path
          required: true
          description: The unique slug of the page (e.g., "home").
          schema:
            type: string
            example: "home"
        - name: lang
          in: query
          required: false
          schema:
            type: string
            example: "fa"
            default: "fa"
          description: Filter by language.
      responses:
        "200":
          description: Page layout retrieved and resolved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PageApiResponse'
        "404":
          description: Page not found
  /categories:
    get:
      tags:
        - categories
      summary: Get post categories
      description: Returns a list of categories. Use parentId query to get sub-categories.
      parameters:
        - name: lang
          in: query
          required: false
          schema:
            type: string
            example: "fa"
            default: "fa"
          description: Filter by language.
        - name: parentId
          in: query
          required: false
          schema:
            type: string
            format: uuid
          description: Provide a parent ID to fetch its direct sub-categories. Omit for top-level categories.
      responses:
        "200":
          description: List of categories retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CategoriesApiResponse'
  /articles:
    get:
      tags:
        - articles
      summary: Get articles
      description: Returns a paginated list of articles.
      parameters:
        - name: lang
          in: query
          required: false
          schema:
            type: string
            example: "fa"
            default: "fa"
        - name: categoryId
          in: query
          required: false
          schema:
            type: string
            format: uuid
        - name: page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
      responses:
        "200":
          description: List of articles retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ArticleListApiResponse'
  /articles/search:
    get:
      tags:
        - articles
      summary: Search for articles
      description: Returns a paginated list of articles based on search criteria.
      parameters:
        - name: q
          in: query
          required: false
          schema:
            type: string
          description: Search query for title and content.
        - name: categoryId
          in: query
          required: false
          schema:
            type: string
            format: uuid
          description: Filter by category ID.
        - name: post_type
          in: query
          required: false
          schema:
            type: string
            enum: [article, audio, video, poster]
          description: Filter by post type.
        - name: lang
          in: query
          required: false
          schema:
            type: string
            example: "fa"
            default: "fa"
          description: Filter by language.
        - name: page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Page number.
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
          description: Items per page.
      responses:
        "200":
          description: A paginated list of matching articles.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ArticleListApiResponse'
  /articles/{id}:
    get:
      tags:
        - articles
      summary: Get single article
      description: Returns details for a specific article, including user-specific like/bookmark status if authenticated.
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Article ID
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Article details retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ArticleApiResponse'
        "404":
          description: Article not found
  /articles/{id}/share:
    post:
      tags:
        - articles
      summary: Increment article share count
      description: Increments the share_count of an article by 1.
      parameters:
        - name: id
          in: path
          required: true
          description: Article ID
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
      responses:
        "200":
          description: Share count incremented
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: integer
                    example: 200
                  message:
                    type: string
                    example: "Share count incremented"
                  data:
                    type: object
                    properties:
                      share_count:
                        type: integer
                        example: 1
        "404":
          description: Article not found
  /articles/new:
    get:
      tags:
        - articles
      summary: Get recently published articles
      description: Returns a paginated list of articles ordered by creation date (newest first), including category information.
      parameters:
        - name: lang
          in: query
          required: false
          schema:
            type: string
            example: "fa"
            default: "fa"
          description: Filter by language.
        - name: page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Page number.
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
          description: Items per page.
      responses:
        "200":
          description: List of articles retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ArticleListApiResponse'
  /comments:
    post:
      tags:
        - comments
      summary: Create a new comment
      description: Submits a new comment for an article. Requires authentication. Comments require admin approval.
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - content
                - articleId
              properties:
                content:
                  type: string
                  example: "این یک کامنت عالی است!"
                articleId:
                  type: string
                  format: uuid
                  example: "e1f8a0d9-9cba-46cd-9ac0-b72a559f3a6f"
                parentId:
                  type: string
                  format: uuid
                  example: "c1a2b3d4-e5f6-7890-g1h2-i3j4k5l6m7n8"
                  nullable: true
      responses:
        "201":
          description: Comment submitted successfully and awaiting approval.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommentResponse'
        "400":
          description: Bad request (missing fields)
        "401":
          description: Unauthorized
        "404":
          description: Article or Parent Comment not found
  /comments/article/{articleId}:
    get:
      tags:
        - comments
      summary: Get comments for an article
      description: Returns a paginated list of approved comments and replies for a specific article.
      parameters:
        - name: articleId
          in: path
          required: true
          description: Article ID
          schema:
            type: string
            format: uuid
        - name: page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        "200":
          description: A paginated list of comments.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommentListUserResponse'
  /comments/{id}/like:
    post:
      tags:
        - comments
      summary: Like, dislike, or remove action for a comment
      description: Allows an authenticated user to like, dislike, or remove their action from a comment.
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Comment ID
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - status
              properties:
                status:
                  type: string
                  enum: [like, dislike, none]
                  example: "like"
      responses:
        "200":
          description: Action updated successfully.
        "201":
          description: Action created successfully.
        "400":
          description: Invalid status field
        "401":
          description: Unauthorized
        "404":
          description: Comment not found
  /comments/{id}/status:
    get:
      tags:
        - comments
      summary: Get user's like/dislike status for a comment
      description: Checks if the authenticated user has liked, disliked, or not acted on a comment.
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Comment ID
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: User's status for the comment.
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: integer
                    example: 200
                  data:
                    type: object
                    properties:
                      status:
                        type: string
                        enum: [like, dislike, none]
                        example: "like"
        "401":
          description: Unauthorized
        "404":
          description: Comment not found
  /article_bookmarks:
    get:
      tags:
        - bookmarks
      summary: Get my bookmarked articles
      description: Returns a paginated list of articles the authenticated user has bookmarked.
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        "200":
          description: A paginated list of bookmarked articles.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ArticleListApiResponse'
        "401":
          description: Unauthorized
  /article_bookmarks/{id}:
    post:
      tags:
        - bookmarks
      summary: Toggle article bookmark
      description: Adds or removes an article from the user's bookmarks.
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Article ID to bookmark/unbookmark
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
      responses:
        "201":
          description: Article bookmarked successfully.
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: integer
                    example: 201
                  message:
                    type: string
                    example: "Article bookmarked successfully."
        "200":
          description: Bookmark removed successfully.
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: integer
                    example: 200
                  message:
                    type: string
                    example: "Bookmark removed successfully."
        "401":
          description: Unauthorized
        "404":
          description: Article not found
  /article_likes:
    get:
      tags:
        - likes
      summary: Get my liked articles
      description: Returns a paginated list of articles the authenticated user has liked.
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
      responses:
        "200":
          description: A paginated list of liked articles.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ArticleListApiResponse'
        "401":
          description: Unauthorized
  /article_likes/{id}:
    post:
      tags:
        - likes
      summary: Toggle article like
      description: Adds or removes a like from an article for the user.
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Article ID to like/unlike
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
      responses:
        "201":
          description: Article liked successfully.
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: integer
                    example: 201
                  message:
                    type: string
                    example: "Article liked successfully."
        "200":
          description: Article unliked successfully.
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: integer
                    example: 200
                  message:
                    type: string
                    example: "Article unliked successfully."
        "401":
          description: Unauthorized
        "404":
          description: Article not found
  /article_likes/{id}/status:
    get:
      tags:
        - likes
      summary: Get user's like status for an article
      description: Checks if the authenticated user has liked a specific article.
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Article ID
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: User's like status for the article.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserLikeStatusResponse'
        "401":
          description: Unauthorized
        "404":
          description: Article not found
  /remote_config/splash:
    post:
      tags:
        - remote_config
      summary: Get splash screen remote config
      security:
        - bearerAuth: []
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              properties: {}
      responses:
        "200":
          description: Splash config retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: integer
                    example: 200
                  config:
                    type: object
                    example: { "splash_image_url": "...", "min_version": "1.0.1" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Unauthorized"
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    PageItem:
      type: object
      properties:
        id:
          type: string
          example: "e1f8a0d9-9cba-46cd-9ac0-b72a559f3a6f"
        title:
          type: string
          example: "تیتر آیتم"
        subtitle:
          type: string
          example: "زیرتیتر"
          nullable: true
        imageUrl:
          type: string
          example: "uploads/articles/cover.png"
          nullable: true
        link:
          type: string
          example: "asar://matna.app?source=post&id=e1f8a0d9-9cba-46cd-9ac0-b72a559f3a6f"
        badgeText:
          type: string
          nullable: true
        meta:
          type: object
          nullable: true
    PageRow:
      type: object
      properties:
        id:
          type: string
          example: "row-123"
        type:
          type: string
          example: "hero"
        title:
          type: string
          example: "عنوان ردیف"
          nullable: true
        subtitle:
          type: string
          nullable: true
        columns:
          type: integer
          example: 2
          nullable: true
        backgroundColor:
          type: string
          example: "#FFFFFF"
          nullable: true
        textColor:
          type: string
          example: "#000000"
          nullable: true
        items:
          type: array
          items:
            $ref: '#/components/schemas/PageItem'
    PageApiResponse:
      type: object
      properties:
        status:
          type: integer
          example: 200
        data:
          type: object
          properties:
            slug:
              type: string
              example: "home"
            language:
              type: string
              example: "fa"
            title:
              type: string
              example: "Home"
            rows:
              type: array
              items:
                $ref: '#/components/schemas/PageRow'
    PostCategory:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "a1b2c3d4-e5f6-7890-g1h2-i3j4k5l6m7n8"
        name:
          type: string
          example: "اخبار"
        image:
          type: string
          example: "uploads/categories/image.png"
          nullable: true
        lang:
          type: string
          example: "fa"
        is_active:
          type: boolean
          example: true
    CategoriesApiResponse:
      type: object
      properties:
        status:
          type: integer
          example: 200
        data:
          type: object
          properties:
            categories:
              type: array
              items:
                $ref: '#/components/schemas/PostCategory'
        cached:
          type: boolean
          example: false
    Article:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "e1f8a0d9-9cba-46cd-9ac0-b72a559f3a6f"
        post_type:
          type: string
          enum: [article, audio, video, poster]
          example: "article"
        title:
          type: string
          example: "تیتر مقاله"
        content:
          type: string
          example: "<p>متن <strong>HTML</strong>.</p>"
          nullable: true
        source:
          type: string
          example: "uploads/articles/media.mp4"
          nullable: true
        image:
          type: string
          example: "uploads/articles/cover.png"
          nullable: true
        share_count:
          type: integer
          example: 0
        lang:
          type: string
          example: "fa"
        is_active:
          type: boolean
          example: true
        categoryId:
          type: string
          format: uuid
          example: "a1b2c3d4-e5f6-7890-g1h2-i3j4k5l6m7n8"
        created_at:
          type: string
          format: date-time
          example: "2025-11-11T10:00:00.000Z"
        updated_at:
          type: string
          format: date-time
          example: "2025-11-11T10:00:00.000Z"
        category:
          $ref: '#/components/schemas/PostCategory'
    ArticleWithStats:
      allOf:
        - $ref: '#/components/schemas/Article'
        - type: object
          properties:
            likes_count:
              type: integer
              example: 12
            bookmarks_count:
              type: integer
              example: 5
            comments_count:
              type: integer
              example: 3
            is_liked:
              type: boolean
              example: true
            is_bookmarked:
              type: boolean
              example: false
    ArticleApiResponse:
      type: object
      properties:
        status:
          type: integer
          example: 200
        data:
          type: object
          properties:
            article:
              $ref: '#/components/schemas/ArticleWithStats'
        cached:
          type: boolean
          example: false
    PaginationMetadata:
      type: object
      properties:
        total:
          type: integer
          example: 120
        page:
          type: integer
          example: 1
        limit:
          type: integer
          example: 10
        total_pages:
          type: integer
          example: 12
        has_next_page:
          type: boolean
          example: true
        has_prev_page:
          type: boolean
          example: false
    ArticleListApiResponse:
      type: object
      properties:
        status:
          type: integer
          example: 200
        data:
          type: object
          properties:
            articles:
              type: array
              items:
                $ref: '#/components/schemas/Article'
            metadata:
              $ref: '#/components/schemas/PaginationMetadata'
        cached:
          type: boolean
          example: false
    UserSummaryComment:
      type: object
      properties:
        id:
          type: string
          format: uuid
        firstname:
          type: string
        lastname:
          type: string
        profile_pic:
          type: string
          nullable: true
    Comment:
      type: object
      properties:
        id:
          type: string
          format: uuid
        content:
          type: string
        created_at:
          type: string
          format: date-time
        likes_count:
          type: integer
          example: 10
        dislikes_count:
          type: integer
          example: 1
        userLikeStatus:
          type: string
          enum: [like, dislike, none]
          description: "Like status for the requesting user"
        user:
          $ref: '#/components/schemas/UserSummaryComment'
        replies:
          type: array
          items:
            $ref: '#/components/schemas/Comment'
    CommentResponse:
      type: object
      properties:
        status:
          type: integer
          example: 201
        message:
          type: string
        data:
          $ref: '#/components/schemas/Comment'
    CommentListUserResponse:
      type: object
      properties:
        status:
          type: integer
          example: 200
        data:
          type: object
          properties:
            comments:
              type: array
              items:
                $ref: '#/components/schemas/Comment'
            metadata:
              $ref: '#/components/schemas/PaginationMetadata'
    UserLikeStatusResponse:
      type: object
      properties:
        status:
          type: integer
          example: 200
        data:
          type: object
          properties:
            liked:
              type: boolean
              example: true
security:
  - bearerAuth: []
